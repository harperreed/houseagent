<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HouseAgent Dashboard - GlaDOS is Watching</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ¤– HouseAgent Dashboard</h1>
            <div class="status">
                <span id="status-indicator" class="status-dot connecting"></span>
                <span id="status-text">Connecting...</span>
                <span id="message-count">0 messages</span>
            </div>
        </header>

        <div class="grid">
            <!-- AI Responses -->
            <div class="panel ai-panel">
                <h2>GlaDOS Responses</h2>
                <div id="ai-messages" class="message-list"></div>
            </div>

            <!-- Situations -->
            <div class="panel situation-panel">
                <h2>Situations Detected</h2>
                <div id="situations" class="message-list"></div>
            </div>

            <!-- Sensor Events -->
            <div class="panel sensor-panel">
                <h2>Recent Sensor Events</h2>
                <div id="sensor-events" class="message-list"></div>
            </div>

            <!-- System Log -->
            <div class="panel log-panel">
                <h2>All Events</h2>
                <div id="all-events" class="message-list"></div>
            </div>

            <!-- Camera Snapshots -->
            <div class="panel camera-panel">
                <div class="panel-header">
                    <h2>ðŸ“· Camera Snapshots</h2>
                    <button id="refresh-all-btn" class="action-btn">Refresh All</button>
                </div>
                <div id="camera-grid" class="camera-grid">
                    <!-- Cameras will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const aiMessages = document.getElementById('ai-messages');
        const situations = document.getElementById('situations');
        const sensorEvents = document.getElementById('sensor-events');
        const allEvents = document.getElementById('all-events');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const messageCount = document.getElementById('message-count');

        let totalMessages = 0;
        const cameraStates = new Map(); // Track latest snapshot per camera

        // Connect to SSE stream
        const eventSource = new EventSource('/stream');

        eventSource.onopen = () => {
            statusIndicator.className = 'status-dot connected';
            statusText.textContent = 'Connected';
        };

        eventSource.onerror = () => {
            statusIndicator.className = 'status-dot error';
            statusText.textContent = 'Connection Error';
        };

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            totalMessages++;
            messageCount.textContent = `${totalMessages} messages`;

            // Add to appropriate panel
            if (data.type === 'camera') {
                updateCameraSnapshot(data);
            } else {
                addMessage(data);
            }

            // Add to all events
            addToAllEvents(data);
        };

        function addMessage(data) {
            const timestamp = new Date(data.timestamp).toLocaleTimeString();

            if (data.type === 'ai_response') {
                // GlaDOS response
                const msg = createMessageElement(
                    timestamp,
                    data.payload,
                    'ai'
                );
                prependMessage(aiMessages, msg);
            } else if (data.type === 'situation') {
                // Situation bundle
                const payload = data.payload;
                const situation = typeof payload === 'string' ? JSON.parse(payload) : payload;
                const msg = createSituationElement(timestamp, situation);
                prependMessage(situations, msg);
            } else {
                // Sensor event
                const msg = createSensorElement(timestamp, data.topic, data.payload);
                prependMessage(sensorEvents, msg);
            }
        }

        function createMessageElement(timestamp, content, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `
                <div class="message-time">${timestamp}</div>
                <div class="message-content">${escapeHtml(String(content))}</div>
            `;
            return div;
        }

        function createSituationElement(timestamp, situation) {
            const div = document.createElement('div');
            div.className = 'message situation';

            const messages = situation.messages || [];
            const zones = messages.map(m => m.zone_id).filter((v, i, a) => a.indexOf(v) === i);
            const types = messages.map(m => m.sensor_type).filter((v, i, a) => a.indexOf(v) === i);

            div.innerHTML = `
                <div class="message-time">${timestamp}</div>
                <div class="message-content">
                    <strong>${messages.length} events</strong> in ${zones.join(', ')}
                    <br>Sensors: ${types.join(', ')}
                    ${situation.confidence ? `<br>Confidence: ${(situation.confidence * 100).toFixed(0)}%` : ''}
                </div>
            `;
            return div;
        }

        function createSensorElement(timestamp, topic, payload) {
            const div = document.createElement('div');
            div.className = 'message sensor';

            let content = '';
            if (typeof payload === 'object') {
                const entity = payload.entity_id || payload.sensor_id || 'unknown';
                const state = payload.to_state || payload.value || JSON.stringify(payload);
                content = `<strong>${entity}</strong>: ${escapeHtml(String(state))}`;
            } else {
                content = escapeHtml(String(payload));
            }

            div.innerHTML = `
                <div class="message-time">${timestamp}</div>
                <div class="message-topic">${topic}</div>
                <div class="message-content">${content}</div>
            `;
            return div;
        }

        function addToAllEvents(data) {
            const timestamp = new Date(data.timestamp).toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `message ${data.type}`;
            div.innerHTML = `
                <div class="message-time">${timestamp}</div>
                <div class="message-topic">${data.topic}</div>
                <div class="message-content">${escapeHtml(JSON.stringify(data.payload, null, 2))}</div>
            `;
            prependMessage(allEvents, div);
        }

        function prependMessage(container, element) {
            container.insertBefore(element, container.firstChild);
            // Keep only last 20 messages
            while (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load initial messages
        fetch('/api/messages')
            .then(r => r.json())
            .then(messages => {
                messages.reverse().forEach(msg => {
                    if (msg.type === 'camera') {
                        updateCameraSnapshot(msg);
                    } else {
                        addMessage(msg);
                    }
                    addToAllEvents(msg);
                });
            })
            .catch(err => console.error('Failed to load initial messages:', err));

        // Camera panel functions
        function updateCameraSnapshot(data) {
            const entityId = data.payload.entity_id || '';
            const cameraId = entityId.startsWith('camera.') ? entityId.substring(7) : entityId;
            const attrs = data.payload.attributes;

            cameraStates.set(cameraId, {
                image: attrs.image_base64,
                analysis: attrs.vision_analysis,
                zone: attrs.zone,
                name: attrs.camera_name,
                timestamp: attrs.timestamp
            });

            renderCamera(cameraId);
        }

        function renderCamera(cameraId) {
            const state = cameraStates.get(cameraId);
            if (!state) return;

            // Validate image data to prevent XSS
            if (!state.image || !state.image.startsWith('data:image/jpeg;base64,')) {
                console.error('Invalid image data for camera:', cameraId);
                return;
            }

            let cameraDiv = document.getElementById(`camera-${cameraId}`);
            if (!cameraDiv) {
                // Create new camera card
                const grid = document.getElementById('camera-grid');
                cameraDiv = document.createElement('div');
                cameraDiv.id = `camera-${cameraId}`;
                cameraDiv.className = 'camera-card';
                grid.appendChild(cameraDiv);
            }

            const age = Date.now() - new Date(state.timestamp).getTime();
            const ageSeconds = Math.floor(age / 1000);
            const stale = ageSeconds > 120 ? 'stale' : '';

            cameraDiv.innerHTML = `
                <div class="camera-header">
                    <span class="camera-name">${escapeHtml(state.name)}</span>
                    <span class="camera-zone">${escapeHtml(state.zone)}</span>
                </div>
                <img src="${state.image}" alt="${escapeHtml(state.name)}" class="camera-image ${stale}">
                <div class="camera-analysis">${escapeHtml(state.analysis)}</div>
                <div class="camera-footer">
                    <span class="camera-timestamp" data-timestamp="${state.timestamp}">${ageSeconds}s ago</span>
                    <button class="capture-btn" data-camera-id="${escapeHtml(cameraId)}" data-zone="${escapeHtml(state.zone)}">
                        Capture Now
                    </button>
                </div>
            `;
        }

        // Update camera timestamps every 10 seconds
        function updateCameraTimestamps() {
            const timestampElements = document.querySelectorAll('.camera-timestamp');
            timestampElements.forEach(elem => {
                const timestamp = elem.dataset.timestamp;
                if (timestamp) {
                    const age = Date.now() - new Date(timestamp).getTime();
                    const ageSeconds = Math.floor(age / 1000);
                    elem.textContent = `${ageSeconds}s ago`;

                    // Update image stale status
                    const cameraCard = elem.closest('.camera-card');
                    const img = cameraCard.querySelector('.camera-image');
                    if (img) {
                        if (ageSeconds > 120) {
                            img.classList.add('stale');
                        } else {
                            img.classList.remove('stale');
                        }
                    }
                }
            });
        }

        setInterval(updateCameraTimestamps, 10000);

        // Load initial camera states on page load
        fetch('/api/camera/refresh_all', { method: 'POST' })
            .then(r => r.json())
            .then(data => console.log('Initial camera load:', data.requested, 'cameras'))
            .catch(err => console.error('Initial camera load failed:', err));

        // Auto-refresh all cameras every 60 seconds
        setInterval(() => {
            fetch('/api/camera/refresh_all', { method: 'POST' })
                .then(r => r.json())
                .then(data => console.log('Auto-refresh:', data.requested, 'cameras'))
                .catch(err => console.error('Auto-refresh failed:', err));
        }, 60000);

        // Manual refresh all button
        document.getElementById('refresh-all-btn').addEventListener('click', () => {
            fetch('/api/camera/refresh_all', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    console.log('Manual refresh:', data.requested, 'cameras');
                    document.getElementById('refresh-all-btn').textContent = 'Refreshing...';
                    setTimeout(() => {
                        document.getElementById('refresh-all-btn').textContent = 'Refresh All';
                    }, 2000);
                })
                .catch(err => console.error('Manual refresh failed:', err));
        });

        // Per-camera capture button handler (event delegation)
        document.getElementById('camera-grid').addEventListener('click', (e) => {
            if (e.target.classList.contains('capture-btn')) {
                const cameraId = e.target.dataset.cameraId;
                const zone = e.target.dataset.zone;

                e.target.textContent = 'Capturing...';
                e.target.disabled = true;

                fetch('/api/camera/capture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ camera_id: cameraId, zone: zone })
                })
                .then(r => r.json())
                .then(data => {
                    console.log('Capture triggered:', cameraId);
                    setTimeout(() => {
                        e.target.textContent = 'Capture Now';
                        e.target.disabled = false;
                    }, 5000); // 5 second cooldown
                })
                .catch(err => {
                    console.error('Capture failed:', err);
                    e.target.textContent = 'Capture Now';
                    e.target.disabled = false;
                });
            }
        });
    </script>
</body>
</html>
